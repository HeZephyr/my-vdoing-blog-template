---
title: Linux ç³»ç»Ÿè°ƒç”¨å‡½æ•°forkã€vforkã€cloneè¯¦è§£
tags: 
  - Linux
author: 
  name: Pursuit
  link: https://github.com/unique-pure
categories: 
  - å¼€å‘
  - ç³»ç»Ÿæ¶æ„
  - Linux
date: 2024-03-12 21:24:42
permalink: /pages/64b48d/
---
 
## 1 fork

### 1.1 åŸºæœ¬ä»‹ç»

```c
#include <sys/types.h>
#include <unistd.h>

pid_t fork(void)
```

* æè¿°

	> forkç”¨äºåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå®ƒä¸çˆ¶è¿›ç¨‹çš„å”¯ä¸€åŒºåˆ«åœ¨äºå…¶PIDå’ŒPPIDï¼Œä»¥åŠèµ„æºåˆ©ç”¨è®¾ç½®ä¸º0ã€‚<font color="red">æ–‡ä»¶é”å’ŒæŒ‚èµ·ä¿¡å·</font>ï¼ˆæŒ‡å·²ç»è¢«å†…æ ¸å‘é€ç»™ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†å°šæœªè¢«è¯¥è¿›ç¨‹å¤„ç†çš„ä¿¡å·ï¼‰ä¸ä¼šè¢«ç»§æ‰¿ï¼Œå…¶ä»–å’Œçˆ¶è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒï¼š<font color="red">ä¼šè·å¾—çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ã€æ ˆã€æ•°æ®æ®µã€å †ã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†å‡½æ•°ã€è¿›ç¨‹ä¼˜å…ˆçº§ã€ç¯å¢ƒå˜é‡ç­‰èµ„æºçš„å‰¯æœ¬ã€‚</font>

* è¿”å›å€¼

	> æˆåŠŸæ—¶ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDï¼Œåœ¨å­è¿›ç¨‹ä¸­è¿”å› $0$ã€‚å¤±è´¥æ—¶ï¼Œçˆ¶è¿›ç¨‹è¿”å› $-1$ï¼Œä¸åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶é€‚å½“è®¾ç½® errnoã€‚
	>
	> å…¶ä¸­errnoæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒç”¨äºè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨æˆ–åº“å‡½æ•°è°ƒç”¨äº§ç”Ÿçš„é”™è¯¯ä»£ç ã€‚å½“ç³»ç»Ÿè°ƒç”¨æˆ–åº“å‡½æ•°å¤±è´¥æ—¶ï¼Œå®ƒä»¬é€šå¸¸ä¼šè®¾ç½® errno ä»¥æŒ‡ç¤ºé”™è¯¯çš„åŸå› ã€‚
	>
	> ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ errno é”™è¯¯ä»£ç åŠå…¶å«ä¹‰ï¼š
	>
	> * EAGAINï¼šèµ„æºæš‚æ—¶ä¸å¯ç”¨ï¼Œé€šå¸¸æ˜¯å› ä¸ºè¾¾åˆ°äº†ç³»ç»Ÿé™åˆ¶ï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦æˆ–å†…å­˜é™åˆ¶ã€‚
	> * ENOMEMï¼šå†…å­˜ä¸è¶³ï¼Œæ— æ³•åˆ†é…è¯·æ±‚çš„èµ„æºã€‚
	> * EACCESï¼šæƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æŸä¸ªèµ„æºã€‚
	> * EINTRï¼šç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­ã€‚
	> * EINVALï¼šæ— æ•ˆçš„å‚æ•°ã€‚

* é‡ç‚¹

	> fork() å‡½æ•°åˆ›å»ºçš„å­è¿›ç¨‹ä¼šä»çˆ¶è¿›ç¨‹å¤åˆ¶æ‰§è¡Œé¡ºåºã€‚å…·ä½“æ¥è¯´ï¼Œå­è¿›ç¨‹ä¼šä»çˆ¶è¿›ç¨‹å¤åˆ¶å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬æŒ‡ä»¤æŒ‡é’ˆï¼ˆinstruction pointerï¼‰å’Œå¯„å­˜å™¨çš„çŠ¶æ€ã€‚è¿™æ„å‘³ç€å­è¿›ç¨‹å°†ä» fork() ç³»ç»Ÿè°ƒç”¨ä¹‹åçš„æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼Œä¸çˆ¶è¿›ç¨‹åœ¨ fork() ä¹‹ååº”è¯¥æ‰§è¡Œçš„æŒ‡ä»¤å®Œå…¨ç›¸åŒã€‚<font color="red">å› æ­¤ï¼Œfork() ä¹‹åé€šå¸¸ä¼šæœ‰ä¸€ä¸ªåŸºäºè¿”å›å€¼çš„åˆ†æ”¯ç»“æ„ï¼Œä»¥åŒºåˆ†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„æ‰§è¡Œè·¯å¾„ã€‚</font>

### 1.2 forkå®ä¾‹

#### 1.2.1å¤šä¸ªforkè¿”å›å€¼

```c
#include <stdio.h>
#include <unistd.h>

int main() {
    pid_t pid1 = fork();
    pid_t pid2 = fork();
    pid_t pid3 = fork();
    pid_t pid  = getpid();
    printf("The PID of the current process is %d\n Hello World from (%d, %d, %d)\n", pid, pid1, pid2, pid3);
    return 0;
}
```

è¿™æ®µç¨‹åºåŒ…å«äº†ä¸‰ä¸ª fork() è°ƒç”¨ï¼Œæ¯ä¸ª fork() éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚ç”±äºæ¯æ¬¡ fork() è°ƒç”¨éƒ½ä¼šå¯¼è‡´è¿›ç¨‹æ•°ç¿»å€ï¼Œæ‰€ä»¥æ€»å…±ä¼šæœ‰$2^3=8$ä¸ªè¿›ç¨‹ ï¼ˆåŒ…æ‹¬æœ€åˆçš„çˆ¶è¿›ç¨‹ï¼‰ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæ‰“å°å‡ºå®ƒçš„è¿›ç¨‹ ID (pid) ä»¥åŠä¸‰ä¸ª fork() è°ƒç”¨çš„è¿”å›å€¼ (pid1, pid2, pid3)ã€‚

å¾—åˆ°çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

![image-20240312193151556](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240312193151556.png)

æˆ‘ä»¬ç”»ä¸ªçŠ¶æ€æœºæ¥ç†è§£å®ƒä»¬çš„è¾“å‡ºï¼Œå‡è®¾æœ€åˆçš„çˆ¶è¿›ç¨‹PIDä¸º291871ï¼š

![fork_information](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/fork_information.png)

#### 1.2.2 Cè¯­è¨€ forkä¸è¾“å‡º

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>

int main(int argc, char *argv[]) {
  int n = 2;
  for (int i = 0; i < n; i++) {
    fork();
    printf("Hello\n");
  }
  for (int i = 0; i < n; i++) {
    wait(NULL);
  }
}
```

è¿™æ®µä»£ç ä¸­ï¼ŒæŒ‰æˆ‘ä»¬çš„ç†è§£ï¼Œç¬¬ä¸€æ¬¡forkåæœ‰2ä¸ªè¿›ç¨‹ï¼Œç„¶åä¸€èµ·æ‰§è¡Œprintfè¾“å‡ºï¼Œå¾—åˆ°ä¸¤ä¸ª`Hello`ï¼Œç„¶åç¬¬äºŒæ¬¡forkåæœ‰4ä¸ªè¿›ç¨‹ï¼Œç„¶åæ‰§è¡Œprintfï¼Œå¾—åˆ°å››ä¸ª`Hello`ï¼Œåˆ™ä¼šæœ‰6ä¸ª``Hello`ï¼Œå¦‚ä¸‹ï¼š

![image-20240312200038027](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240312200038027.png)

ä½†æ˜¯å½“æˆ‘ä»¬å°†è¾“å‡ºé€šè¿‡ç®¡é“ä¼ ç»™`cat`ç­‰å‘½ä»¤æ—¶ï¼Œä¼šçœ‹åˆ°8ä¸ª`Hello`ï¼š

![image-20240312200714610](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240312200714610.png)

è¿™æ˜¯å› ä¸ºæ ‡å‡†è¾“å‡ºä¸€èˆ¬æ˜¯è¡Œç¼“å†²çš„ï¼Œç¢°åˆ°`\n`ï¼Œç¼“å†²åŒºä¸­çš„å†…å®¹ä¼šè¢«åˆ·æ–°ï¼Œå³è¾“å‡ºåˆ°ç»ˆç«¯æˆ–æ–‡ä»¶ä¸­ã€‚è¿™ç§ç¼“å†²æ–¹å¼çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥å‡å°‘å¯¹ç£ç›˜ I/O çš„è°ƒç”¨æ¬¡æ•°ã€‚

å¦‚æœæ ‡å‡†è¾“å‡ºè¢«é‡å®šå‘åˆ°ç®¡é“ï¼Œå®ƒå¯èƒ½ä¸å†æ˜¯è¡Œç¼“å†²çš„ï¼Œè€Œæ˜¯å˜ä¸ºå…¨ç¼“å†²çš„ã€‚è¿™æ„å‘³ç€ç¼“å†²åŒºå¯èƒ½ä¼šåœ¨å¡«æ»¡æ—¶åˆ·æ–°ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡é‡åˆ°æ¢è¡Œç¬¦æ—¶åˆ·æ–°ã€‚å¦‚æœç¼“å†²åŒºè¶³å¤Ÿå¤§ï¼Œä»¥è‡³äºå¯ä»¥å®¹çº³æ‰€æœ‰çš„ `Hello` è¾“å‡ºï¼Œé‚£ä¹ˆforkçš„æ—¶å€™å­è¿›ç¨‹ä¹Ÿä¼šå¤åˆ¶ç¼“å†²åŒºï¼Œå¯¼è‡´æœ€åæ¯ä¸ªè¿›ç¨‹ä¸­çš„ç¼“å†²åŒºéƒ½æœ‰2ä¸ª`Hello`ï¼Œæœ€åè¾“å‡ºä¸º8ä¸ªã€‚

å¦‚æœä¸ºäº†ç¡®ä¿ç¼“å†²åŒºåœ¨éœ€è¦çš„æ—¶å€™è¢«åˆ·æ–°ï¼Œå¯ä»¥åœ¨ printf è°ƒç”¨ä¹‹åæ˜¾å¼åœ°è°ƒç”¨ `fflush(stdout)` æ¥åˆ·æ–°æ ‡å‡†è¾“å‡ºç¼“å†²åŒºã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ‰€æœ‰çš„è¾“å‡ºéƒ½è¢«ç«‹å³å†™å…¥ï¼Œè€Œä¸ä¼šå—åˆ°ç¼“å†²è¡Œä¸ºçš„å½±å“ã€‚

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>

int main(int argc, char *argv[]) {
  int n = 2;
  for (int i = 0; i < n; i++) {
    fork();
    printf("Hello\n");
    fflush(stdout);
  }
  for (int i = 0; i < n; i++) {
    wait(NULL);
  }
  return 0;
}
```

![image-20240312201140424](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240312201140424.png)

#### 1.2.3 fork ğŸ’£

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>

int main(int argc, char *argv[]) {
  while(1) {
      fork();
  }
  return 0;
}
```

è¿™æ®µä»£ç ä¼šæ— é™å¾ªç¯åœ°è°ƒç”¨ fork() å‡½æ•°ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚ç”±äºæ¯æ¬¡ fork() è°ƒç”¨éƒ½ä¼šæˆåŠŸåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œè€Œä¸”è¿™ä¸ªæ–°è¿›ç¨‹åˆä¼šç«‹å³è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯å¹¶å†æ¬¡è°ƒç”¨ fork()ï¼Œå› æ­¤è¿›ç¨‹çš„æ•°é‡ä¼šä»¥æŒ‡æ•°é€Ÿåº¦å¢é•¿ï¼Œå¾ˆå¿«å°±ä¼šè€—å°½ç³»ç»Ÿçš„å¯ç”¨èµ„æºã€‚

<font color="red">ç»å¯¹ä¸è¦åœ¨ä»»ä½•ç”Ÿäº§ç¯å¢ƒæˆ–æ‚¨æ²¡æœ‰æƒé™çš„ä»»ä½•ç³»ç»Ÿä¸Šè¿è¡Œforkç‚¸å¼¹ã€‚</font>

## 2 vfork

### 2.1 åŸºæœ¬ä»‹ç»

* æè¿°

	```c
	#include <sys/types.h>
	#include <unistd.h>
	
	pid_t vfork(void);
	```

	`vfork()` ç³»ç»Ÿè°ƒç”¨ç”¨äºåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸ `fork()` ç±»ä¼¼ï¼Œä½†å®ƒä½¿ç”¨çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œè€Œä¸æ˜¯å¤åˆ¶çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚<font color="red">`vfork()` è°ƒç”¨åï¼Œçˆ¶è¿›ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°å­è¿›ç¨‹è°ƒç”¨ `exec` å‡½æ•°æˆ–æ‰§è¡Œäº† exit å‡½æ•°ã€‚</font>è¿™æ˜¯å› ä¸ºå­è¿›ç¨‹éœ€è¦ç‹¬å çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚ä¸€ã€‚<font color="red">åœ¨å­è¿›ç¨‹è°ƒç”¨ `exec` å‡½æ•°æˆ–æ‰§è¡Œäº† `exit` å‡½æ•°ä¹‹åï¼Œå­è¿›ç¨‹å°†è·å¾—è‡ªå·±çš„å†…å­˜ç©ºé—´ã€‚</font>

* è¿”å›å€¼

	å’Œ`fork`ä¸€è‡´

* é‡ç‚¹

	> 1. `vfork()` åˆ›å»ºçš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç¯å¢ƒï¼Œä½†ä¸ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„å †æ ˆã€‚
	> 2. åœ¨å­è¿›ç¨‹æ‰§è¡Œè¿™äº›`exec`æˆ–`exit`æ“ä½œä¹‹å‰ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯èƒ½ä¼šè®¿é—®ç›¸åŒçš„å†…å­˜åœ°å€ï¼Œè¿™å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´ã€‚
	> 3. åœ¨ `vfork()` è°ƒç”¨æˆåŠŸåï¼Œå­è¿›ç¨‹åº”è¯¥ç«‹å³è°ƒç”¨ `exec` å‡½æ•°æˆ–æ‰§è¡Œ `exit` å‡½æ•°ã€‚å¦‚æœåœ¨å­è¿›ç¨‹ä¸­ä¿®æ”¹é™¤äº†ç”¨äºå­˜å‚¨ä» `vfork()` è¿”å›å€¼çš„ `pid_t` ç±»å‹å˜é‡ä¹‹å¤–çš„ä»»ä½•æ•°æ®ï¼Œæˆ–è€…ä»è°ƒç”¨ `vfork()` çš„å‡½æ•°è¿”å›ï¼Œæˆ–åœ¨æˆåŠŸè°ƒç”¨ `_exit()` æˆ– `exec()` å‡½æ•°æ—ä¸­çš„ä¸€ä¸ªå‡½æ•°ä¹‹å‰è°ƒç”¨å…¶ä»–ä»»ä½•å‡½æ•°ï¼Œåˆ™è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–è¡¨ç°å‡ºä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚
	> 	å› æ­¤ï¼Œä½¿ç”¨ `vfork()` æ—¶ï¼Œå¿…é¡»ç¡®ä¿å­è¿›ç¨‹åœ¨è°ƒç”¨ `exec` å‡½æ•°æˆ–æ‰§è¡Œ `exit` å‡½æ•°ä¹‹å‰ä¸æ‰§è¡Œä»»ä½•å¯èƒ½å½±å“å…±äº«å†…å­˜çš„æ“ä½œã€‚
	> 4. `vfork()` ç³»ç»Ÿè°ƒç”¨ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œç›´åˆ°å­è¿›ç¨‹å®Œæˆ `exec` è°ƒç”¨æˆ– `exit` è°ƒç”¨ã€‚çˆ¶è¿›ç¨‹ä¸éœ€è¦æ˜¾å¼è°ƒç”¨ `wait()` æˆ– `waitpid()` æ¥ç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚

### 2.2 éªŒè¯vforkå…±äº«å†…å­˜

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>
#include <assert.h>

int main() {
    // åœ¨çˆ¶è¿›ç¨‹ä¸­åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–
    char *buffer = malloc(1024);
    assert(buffer != NULL);
    memset(buffer, 'A', 1024);

    // ä½¿ç”¨vforkåˆ›å»ºå­è¿›ç¨‹
    pid_t pid = vfork();
    if (pid < 0) {
        perror("vfork error");
        exit(EXIT_FAILURE);
    } else if (pid == 0) {
        // å­è¿›ç¨‹
        printf("Child process: PID = %d\n", getpid());

        // ä¿®æ”¹å†…å®¹
        memset(buffer, 'B', 1024);
        // å­è¿›ç¨‹
        char * const argv[] = {"/bin/echo", "Hello, Linux!", NULL};
        char * const envp[] = {NULL};
        // æ‰§è¡Œexecå‡½æ•°
        execve(argv[0], argv, envp);
    } else {
        // çˆ¶è¿›ç¨‹
        printf("Parent process: PID = %d, child's PID = %d\n", getpid(), pid);
        // éªŒè¯å†…å­˜å†…å®¹æ˜¯å¦è¢«å­è¿›ç¨‹ä¿®æ”¹
        for (int i = 0; i < 1024; i++) {
            if (buffer[i] != 'B') {
                printf("Memory corruption detected at index %d\n", i);
                exit(EXIT_FAILURE);
            }
        }
        printf("Memory is consistent\n");
    }
    return 0;
}
```

è¿™ä¸ªç¨‹åºçš„ç›®çš„æ˜¯éªŒè¯åœ¨ `vfork()` ä¹‹åï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹æ˜¯å¦å…±äº«å†…å­˜ã€‚é¦–å…ˆåœ¨çˆ¶è¿›ç¨‹ä¸­åˆ†é…ä¸€å—å†…å­˜ ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºå­—ç¬¦` â€˜Aâ€™`ã€‚ç„¶åï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨ `vfork()` åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ã€‚åœ¨å­è¿›ç¨‹ä¸­ï¼Œç¨‹åºè¯•å›¾å°†å†…å®¹ä¿®æ”¹ä¸ºå­—ç¬¦ `â€˜Bâ€™`ï¼Œå¹¶æ‰§è¡Œ `execve()`ã€‚åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œç¨‹åºæ£€æŸ¥ç¼“å†²åŒºçš„å†…å®¹æ˜¯å¦è¢«ä¿®æ”¹ä¸ºå­—ç¬¦ `â€˜Bâ€™`ï¼Œä»¥éªŒè¯å†…å­˜æ˜¯å¦è¢«æ­£ç¡®å…±äº«ã€‚

ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20240313132239776](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240313132239776.png)

## 3 clone

### 3.1 åŸºæœ¬ä»‹ç»

* æè¿°

	```c
	#define _GNU_SOURCE
	#include <sched.h>
	int clone(int (*fn)(void *), void *child_stack, int flags, void *arg, ...
	                 /* pid_t *parent_tid, void *tls, pid_t *child_tid */ );
	```

	`clone`ä¸`fork`ç±»ä¼¼ï¼Œæ˜¯ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†`clone`æä¾›äº†æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼Œå¯ä»¥ç¡®å®šåœ¨è°ƒç”¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å’Œå­è¿›ç¨‹ä¹‹é—´å…±äº«å“ªäº›æ‰§è¡Œä¸Šä¸‹æ–‡çš„éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œè°ƒç”¨è€…å¯ä»¥æ§åˆ¶ä¸¤ä¸ªè¿›ç¨‹æ˜¯å¦å…±äº«è™šæ‹Ÿåœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦è¡¨å’Œä¿¡å·å¤„ç†ç¨‹åºè¡¨ã€‚è¿™äº›ç³»ç»Ÿè°ƒç”¨è¿˜å…è®¸å°†æ–°çš„å­è¿›ç¨‹æ”¾ç½®åœ¨å•ç‹¬çš„å‘½åç©ºé—´ä¸­ã€‚

* å‚æ•°

	> * `fn`æ˜¯æŒ‡å‘æ–°è¿›ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°çš„æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ª void* å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª int ç±»å‹çš„å€¼ï¼Œè¿™ä¸ªè¿”å›å€¼å°†è¢« clone ç³»ç»Ÿè°ƒç”¨æ•è·ï¼Œå¹¶ä½œä¸ºå­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼›
	>
	> * `child_stack`æ˜¯æ–°è¿›ç¨‹çš„å †æ ˆåœ°å€ï¼Œç”±äºå­è¿›ç¨‹å’Œè°ƒç”¨è¿›ç¨‹å¯èƒ½å…±äº«å†…å­˜ï¼Œå› æ­¤å­è¿›ç¨‹ä¸å¯èƒ½ä¸è°ƒç”¨è¿›ç¨‹åœ¨åŒä¸€å †æ ˆä¸­æ‰§è¡Œã€‚è°ƒç”¨è¿›ç¨‹å¿…é¡»ä¸ºå­å †æ ˆè®¾ç½®å†…å­˜ç©ºé—´ï¼Œå¹¶å°†æŒ‡å‘è¯¥ç©ºé—´çš„æŒ‡é’ˆä¼ é€’ç»™`clone()`ã€‚
	>
	> * `flags`å¯ä»¥è®¾ç½®æ–°è¿›ç¨‹çš„å±æ€§ï¼ˆé€šè¿‡äºŒè¿›åˆ¶ä½è®¾ç½®ï¼‰ï¼ŒåŒ…æ‹¬æ˜¯å¦ä¸åŸè¿›ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼ˆCLONE_VMï¼‰ã€æ˜¯å¦å…±äº«æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ˆCLONE_FILESï¼‰ã€æ˜¯å¦å…±äº«ä¿¡å·å¤„ç†å™¨ï¼ˆCLONE_SIGHANDï¼‰ç­‰ç­‰ï¼›
	>
	> 	`int flags = CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND | CLONE_THREAD | CLONE_SYSVSEM | CLONE_SETTLS;`
	>
	> 	|     æ ‡å¿—      |                             å«ä¹‰                             |
	> 	| :-----------: | :----------------------------------------------------------: |
	> 	| CLONE_PARENT  | åˆ›å»ºçš„å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯è°ƒç”¨è€…çš„çˆ¶è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹ä¸åˆ›å»ºå®ƒçš„è¿›ç¨‹æˆäº†â€œå…„å¼Ÿâ€è€Œä¸æ˜¯â€œçˆ¶å­â€ |
	> 	|   CLONE_FS    | å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬rootã€å½“å‰ç›®å½•ã€umask  |
	> 	|  CLONE_FILES  |   å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰è¡¨    |
	> 	|  CLONE_NEWNS  | åœ¨æ–°çš„namespaceå¯åŠ¨å­è¿›ç¨‹ï¼Œnamespaceæè¿°äº†è¿›ç¨‹çš„æ–‡ä»¶hierarchy |
	> 	| CLONE_SIGHAND |     å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„ä¿¡å·å¤„ç†ï¼ˆsignal handlerï¼‰è¡¨     |
	> 	| CLONE_PTRACE  |               è‹¥çˆ¶è¿›ç¨‹è¢«traceï¼Œå­è¿›ç¨‹ä¹Ÿè¢«trace               |
	> 	|  CLONE_VFORK  |           çˆ¶è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œç›´è‡³å­è¿›ç¨‹é‡Šæ”¾è™šæ‹Ÿå†…å­˜èµ„æº           |
	> 	|   CLONE_VM    |              å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹è¿è¡Œäºç›¸åŒçš„å†…å­˜ç©ºé—´              |
	> 	|   CLONE_PID   |                å­è¿›ç¨‹åœ¨åˆ›å»ºæ—¶PIDä¸çˆ¶è¿›ç¨‹ä¸€è‡´                 |
	> 	| CLONE_THREAD  | Linux 2.4ä¸­å¢åŠ ä»¥æ”¯æŒPOSIXçº¿ç¨‹æ ‡å‡†ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„çº¿ç¨‹ç¾¤ |
	>
	> * `arg`æ˜¯ä¼ é€’ç»™æ–°è¿›ç¨‹çš„å‚æ•°ï¼›
	>
	> * å¯é€‰å‚æ•°ï¼ŒåŒ…æ‹¬ `pid_t *parent_tid`ç­‰ã€‚

* è¿”å›å€¼

	> æˆåŠŸæ—¶ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDã€‚å¤±è´¥æ—¶ï¼Œçˆ¶è¿›ç¨‹è¿”å› $-1$ï¼Œä¸åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶é€‚å½“è®¾ç½® `errno`ã€‚

* é‡ç‚¹

	> 1. `clone` å¯ä»¥åˆ›å»ºæ–°çš„è¿›ç¨‹æˆ–çº¿ç¨‹ï¼ŒLinuxåˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨å°±æ˜¯`clone`ã€‚è€Œ `fork` å’Œ`vfork`åªèƒ½åˆ›å»ºè¿›ç¨‹ã€‚è¿™æ„å‘³ç€ `clone` å¯ä»¥åœ¨å•ä¸ªè¿›ç¨‹ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè€Œ `fork` åˆ™æ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚
	> 2. `clone` æä¾›æ¯” `fork` å’Œ `vfork` æ›´å¤šçš„é€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šå­è¿›ç¨‹æˆ–çº¿ç¨‹çš„å †æ ˆã€ä¿¡å·å¤„ç†ã€æƒé™ç­‰ã€‚
	> 3. `clone` çš„ä½¿ç”¨æ¯” `fork` å’Œ `vfork` æ›´å¤æ‚ï¼Œéœ€è¦æ­£ç¡®è®¾ç½® flagsã€child_stackã€parent_pidptrã€ptrã€stack_size å’Œ tls ç­‰å‚æ•°ã€‚

### 3.2 cloneä½¿ç”¨

```c
#define _GNU_SOURCE
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/wait.h>
#include <unistd.h>

#define STACK_SIZE (1024 * 1024) /* Stack size for cloned child */
// å®ï¼Œç®€åŒ–é”™è¯¯å¤„ç†
#define ERREXIT(msg) { perror(msg); exit(EXIT_FAILURE); }
// å®‰å…¨åˆ†é…å†…å­˜å‡½æ•°ï¼Œåˆ†é…å¤±è´¥æŠ¥å‘Šé”™è¯¯
#define CHECKALLOC(ptr, msg)  ({ void *p = ptr; if (p == NULL) {ERREXIT(msg);} p;})

/*
 * å­è¿›ç¨‹å‡½æ•°
 * params: æ¥å—ä¸€ä¸ªvoid *ç±»å‹å‚æ•°ï¼Œä½†æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨è¿‡ï¼Œåé¢çš„å£°æ˜æ˜¯ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå‚æ•°æ˜¯æœªè¢«ä½¿ç”¨çš„
 */
static int childFunc(void *arg __attribute__((unused))) {
    puts("child: start");
    sleep(2);
    puts("child: terminate");
    return 0; /* Child terminates now */

}

int main(int argc, char *argv[]) {
    /* Start of stack buffer */
    char **stacks;
    /* Child process's pids */
    pid_t *pids;
    size_t nproc, i;

    // æ¥å—ä¸¤ä¸ªå‚æ•°
    if (argc != 2) {
        puts("Wrong way to execute the program:\n"
                "\t\t./waitpid nProcesses\n"
                "example:\t./waitpid 2");

        return EXIT_FAILURE;

    }
    // åˆå§‹åŒ–nprocï¼Œè¡¨ç¤ºè¦åˆ›å»ºçš„å­è¿›ç¨‹æ•°
    nproc = atol(argv[1]);  /* Process count */

    // åˆ†é…å†…å­˜ç©ºé—´
    stacks = CHECKALLOC(malloc(nproc * sizeof(void *)), "malloc");
    pids = CHECKALLOC(malloc(nproc * sizeof(pid_t)), "malloc");

    for (i = 0; i < nproc; i++) {
        char *stackTop; /* End of stack buffer */
        stacks[i] = CHECKALLOC(malloc(STACK_SIZE), "stack malloc");
        // å¾—åˆ°æ ˆé¡¶ä½ç½®
        stackTop = stacks[i] + STACK_SIZE;

        /*
         * åˆ›å»ºå­è¿›ç¨‹
         * ç¬¬ä¸€ä¸ªæ ‡å¿—è¡¨ç¤ºåœ¨å­è¿›ç¨‹æ¸…é™¤çº¿ç¨‹ç»„IDï¼ˆTIDï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹æˆ–å…¶ä»–å­è¿›ç¨‹çš„çº¿ç¨‹ç»„IDå†²çª
         * ç¬¬äºŒä¸ªè¡¨ç¤ºå‘Šè¯‰åœ¨å­è¿›ç¨‹ä¸­è®¾ç½®çº¿ç¨‹IDï¼Œç›®çš„æ˜¯ä¸ºäº†å…è®¸çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ä¸­è¿½è¸ªçº¿ç¨‹
         * å‘Šè¯‰ clone ç³»ç»Ÿè°ƒç”¨åœ¨å­è¿›ç¨‹ä¸­é‡æ–°å®‰è£…ä¿¡å·å¤„ç†ç¨‹åºï¼Œç›®çš„æ˜¯ä¸ºäº†å…è®¸å­è¿›ç¨‹æ•è·å’Œå¤„ç†ä¿¡å·ï¼Œè€Œä¸æ˜¯ä¼ é€’ç»™çˆ¶è¿›ç¨‹ã€‚
         */
        pids[i] = clone(childFunc, stackTop, CLONE_CHILD_CLEARTID | CLONE_CHILD_SETTID | SIGCHLD, NULL);
        if (pids[i] == -1)
            ERREXIT("clone");
        printf("clone() returned %ld\n", (long)pids[i]);

    }

    sleep(1);

    // ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹
    for (i = 0; i < nproc; i++) {
        // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå­è¿›ç¨‹idï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºä¸å…³å¿ƒå­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºç­‰å¾…ä»»ä½•å­è¿›ç¨‹
        if (waitpid(pids[i], NULL, 0) == -1)
            ERREXIT("waitpid");
        printf("child %ld has terminated\n", (long)pids[i]);

    }

    // å›æ”¶å†…å­˜ç©ºé—´
    for (i = 0; i < nproc; i++)
        free(stacks[i]);
    free(stacks);
    free(pids);
    return EXIT_SUCCESS;

}
```

è¿è¡Œï¼š`gcc clone-example.c && ./a.out 5`ï¼Œå…¶ä¸­5ä¸º`nproc`ï¼Œè¡¨ç¤ºè¦åˆ›å»ºçš„è¿›ç¨‹æ•°ã€‚

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-20240313212733984](https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/image-20240313212733984.png)